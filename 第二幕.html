<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è“å®çŸ³æ¡ˆ - ç¬¬äºŒå¹•</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- é…ç½®æ¨¡å—æ˜ å°„ -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>
    
    <style>
        body { margin: 0; background-color: #f3f4f6; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 20px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
import React, { useState, useEffect, useRef } from 'react';
import { createRoot } from 'react-dom/client';
import { 
  ArrowRight, Search, Pin, MessageSquare, 
  Play, SkipForward, Send, Lightbulb,
  AlertCircle, Loader2, Info
} from 'lucide-react';

// --- ç³»ç»Ÿé…ç½® ---
const DIFY_BASE_URL = "http://ops.pd.ximalaya.local/dify/v1";
const DIFY_API_KEY = "app-Y9KhYsOSv3mYYicXVVj9qOVY";

// --- èµ„æºé…ç½® ---
const ASSETS = {
    BG_221B: "./pic/scene/scene_livingroom.jpg",
    BG_CLIMAX: "./pic/scene/scene4.jpg",
    CHAR_HOLMES: "./pic/character/character_sherlock.png",
    CHAR_WATSON: "./pic/character/character_waston.png",
    CHAR_PLAYER: "./pic/character/character_player.png",
    CHAR_PETERSON: "./pic/character/character_peterson.png",
    BGM: "./voice/bgm/bgm1.mp3",
};

// --- æ¸¸æˆæ ¸å¿ƒé…ç½®ä¸é™æ€å½©è›‹æ–‡æ¡ˆ ---
const GAME_CONFIG = {
  // ä¾§è¾¹æ å›ºå®šæ–‡æ¡ˆï¼ˆå½©è›‹ï¼‰
  sidebars: {
    easterEggs: [
      { title: "ã€ç‹¬å®¶å…«å¦ã€‘", content: "ä¼ åç”ŸåŒ»ç”Ÿå³å°†å¤§å©šæ¬ç¦»è´å…‹è¡—ã€‚å“ˆå¾·æ£®å¤ªå¤ªé€éœ²ï¼ŒäºŒæ¥¼é‚£ä½æˆ¿å®¢å·²è¿ç»­ä¸‰æ™šåœ¨çª—å‰æ‹‰å¥æœ€ä¸ºå‡„å‡‰çš„å°æç´æ›²ï¼Œå¬è€…è½æ³ªã€‚" },
      { title: "ã€ç‹¬å®¶å…«å¦ã€‘", content: "ã€Šæµ·æ»¨æ‚å¿—ã€‹ç¼–è¾‘éƒ¨çˆ†æ–™ï¼šåç”ŸåŒ»ç”Ÿçš„æ–°ä½œè¢«é€€ç¨¿ã€‚ç†ç”±æ˜¯â€œè¯·å¢åŠ æ¡ˆæƒ…æ¨ç†æ¯”é‡ï¼Œåˆ å‡å¯¹ä¾¦æ¢ä¾§å½±åŠè¿·äººçœ¼ç¥çš„è¿‡åº¦æå†™â€ã€‚" },
      { title: "ã€è­¦å‘Šï¼ã€‘", content: "æ•¬å‘Šä¼¦æ•¦å±…æ°‘ï¼è‹¥ä¿¡å°ä¸­å€’å‡ºäº”æšå¹²ç˜ªæ©˜æ ¸ï¼Œåˆ‡å‹¿å½“ä½œæ¶ä½œå‰§ï¼æ­¤ä¹ƒå¿…æ­»é€šçŸ¥ã€‚å»ºè®®æ”¶ä¿¡è€…ç«‹åˆ»ç«‹é—å˜±ï¼Œå› ä¸ºè¿è´å…‹è¡—é‚£ä½ä¹Ÿæœªå¿…èƒ½æ•‘ä½ ã€‚" },
      { title: "ã€ç‹¬å®¶å…«å¦ã€‘", content: "è«é‡Œäºšè’‚æ•™æˆè±ªæ·åƒé‡‘è´­å…¥åç”»ï¼Œå¼•å‘æ”¶å…¥æ¥æºè´¨ç–‘ã€‚æŸä¾¦æ¢å†·è¯„ï¼šâ€œä»…é é‚£æœ¬æ— äººé—®æ´¥çš„æ•°å­¦ä¹¦ï¼Œä»–ææ€•è¿ç”»æ¡†éƒ½ä¹°ä¸èµ·ã€‚â€" },
      { title: "ã€ç‹¬å®¶å…«å¦ã€‘", content: "é›·æ–¯å‚å¾·ä¸è‘›è±æ£®äº‰å¤ºâ€œæœ€ä½³è­¦æ¢â€å¤´è¡”ï¼Œäº’ä¸ç›¸è®©ã€‚å¸‚æ°‘è°ƒä¾ƒï¼šâ€œçœçœå§ï¼Œæœ€åè°ä¸æ˜¯è¿˜å¾—å»è´å…‹è¡—çš„é‚£é—´å®¢å…æ±‚æ•‘ï¼Ÿâ€" }
    ],
    ad: 'å¹¿å‘Šï¼š221B è´å…‹è¡—å°šæœ‰ç©ºæˆ¿ï¼Œé™å•èº«ç»…å£«ã€‚'
  }
};

// --- å‰§æœ¬æ•°æ® ---
const ACT2_INTRO_SCRIPT_PART1 = [
    { speaker: "æ—ç™½", text: "ï¼ˆå½¼å¾—æ£®è¿˜åœ¨å¤§å£å–˜æ°”ï¼Œç¦å°”æ‘©æ–¯å´çªç„¶é™äº†ä¸‹æ¥ã€‚ä»–ç”¨é•Šå­å¤¹èµ·é‚£é¢—è“å®çŸ³ï¼Œå¯¹ç€å†¬æ—¥çš„å†·å…‰è½¬åŠ¨ï¼Œçœ¼ç¥ä¸­é—ªçƒç€çŒé£Ÿè€…çš„å…´å¥‹ã€‚ï¼‰" },
    { speaker: "ç¦å°”æ‘©æ–¯", text: "çœ‹è¿™å…‰èŠ’ï¼Œé˜Ÿé•¿ã€‚ä¸ä»…æ˜¯è¯±äººï¼Œç®€ç›´æ˜¯é‚ªæ¶ã€‚è¿™é¢—å®çŸ³å‡ºä¸–æ‰äºŒåå¹´ï¼Œå·²ç»å¼•å‘äº†ä¸¤èµ·è°‹æ€æ¡ˆã€ä¸€æ¬¡æ³¼ç¡«é…¸æ¯å®¹æ¡ˆã€‚", char: "CHAR_HOLMES", audio: "./voice/chapter2/sherlock/çœ‹è¿™å…‰èŠ’ï¼Œé˜Ÿ.m4a" },
    { speaker: "ç¦å°”æ‘©æ–¯", text: "è€Œç°åœ¨ï¼Œå®ƒå‡ºç°åœ¨äº†æœ€è’è°¬çš„åœ°æ–¹â€”â€” ä¸€åªåœ£è¯é¹…çš„è‚šå­é‡Œã€‚", char: "CHAR_HOLMES", audio: "./voice/chapter2/sherlock/è€Œç°åœ¨ï¼Œå®ƒå‡º.m4a" },
    { speaker: "æˆ‘", text: "è¿™ä¸œè¥¿æ€ä¹ˆä¼šâ€¦â€¦", char: "CHAR_PLAYER" },
    { speaker: "æ—ç™½", text: "ï¼ˆåç”Ÿå°†æŠ¥çº¸æ¨åˆ°æˆ‘é¢å‰ï¼‰", nextState: "TIMES_REVEAL" }
];

const ACT2_INTRO_SCRIPT_PART2 = [
    { speaker: "æˆ‘", text: "ç­‰ç­‰ï¼Œæˆ‘æœ‰ç‚¹ç³Šæ¶‚äº†â€¦â€¦ç§ç§è¯æ®è¡¨æ˜æ˜¯é…’åº—çš„ç®¡å­å·¥éœçº³å·äº†å®çŸ³ï¼Œä½†å®çŸ³ç°åœ¨å´å‡ºç°åœ¨ä¸€åªå±äºâ€œäº¨åˆ©Â·è´å…‹â€çš„é¹…è‚šå­é‡Œã€‚è¿™æ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Ÿ", char: "CHAR_PLAYER" },
    { speaker: "ç¦å°”æ‘©æ–¯", text: "æ²¡é”™ï¼Œè¿™ä¸‹æƒ…å†µå˜äº†ã€‚ä¸ç®¡éœçº³æ˜¯ä¸æ˜¯æ— è¾œçš„ï¼Œäº¨åˆ©Â·è´å…‹éƒ½æ˜¯è§£å¼€è°œé¢˜çš„å”¯ä¸€çº¿ç´¢ã€‚", char: "CHAR_HOLMES", audio:"./voice/chapter2/sherlock/æ²¡é”™ï¼Œè¿™ä¸‹æƒ….m4a" },
    { speaker: "æˆ‘", text: "æˆ‘ä»¬éœ€è¦ç«‹åˆ»æ‰¾åˆ°ä»–ï¼", char: "CHAR_PLAYER" },
    { speaker: "ç¦å°”æ‘©æ–¯", text: "æ­£æ˜¯ã€‚é˜Ÿé•¿ï¼Œå¯¹ä½ ä¾¦æ¢ç ´æ¡ˆèƒ½åŠ›çš„è€ƒéªŒæ¥äº†ã€‚æˆ‘ä»¬è¦å¦‚ä½•ä»æ‹¥æœ‰å››ç™¾ä¸‡äººå£çš„ä¼¦æ•¦ï¼ŒæŠŠè¿™ä¸ªäººæŒ–å‡ºæ¥ï¼Ÿ", char: "CHAR_HOLMES", audio:"./voice/chapter2/sherlock/æ­£æ˜¯ï¼Œé˜Ÿé•¿ï¼Œ.m4a", nextState: "STRATEGY_INPUT" }
];

// é™æ€æŠ¥çº¸å†…å®¹ - æ³°æ™¤å£«æŠ¥
const TIMES_ARTICLE = {
    newspaper_headline: "å¤§éƒ½ä¼šé…’åº—ç å®å¤±çªƒæ¡ˆï¼ï¼",
    // æ‹†åˆ†å†…å®¹ä¸ºå—ï¼Œä»¥ä¾¿å¸ƒå±€
    blocks: [
        { title: "æ¡ˆæƒ…æ‘˜è¦", content: "æœ¬æœˆ22æ—¥ï¼Œè«å°”å¡ä¼¯çˆµå¤«äººçš„ç»ä¸–çå®â€œè“å®çŸ³â€åœ¨é…’åº—å¥—æˆ¿å¤±çªƒã€‚è¿™é¢—å®çŸ³ä»·å€¼è¿åŸï¼Œå‡ºä¸–ä»…äºŒåå¹´ã€‚" },
        { title: "å«Œç–‘äºº", content: "çº¦ç¿°Â·éœçº³ï¼ˆ26å²ï¼Œç®¡å­å·¥ï¼‰ã€‚å·²è¢«è­¦æ–¹é€®æ•ï¼Œæ¡ˆå‘æ—¶åªæœ‰ä»–åœ¨æˆ¿å†…ç„Šæ¥å£ç‚‰æ æ†ï¼Œä¸”æœ‰å·çªƒå‰ç§‘ã€‚" },
        { title: "è¯äººæŒ‡è¯", content: "é…’åº—é¢†ç­èµ–å¾·æŒ‡è¯ï¼šæ¡ˆå‘å½“æ—¥ä»–å¸¦éœçº³å…¥å®¤ç»´ä¿®ã€‚èµ–å¾·çŸ­æš‚ç¦»å¼€ï¼Œè¿”å›æ—¶å‘ç°éœçº³å·²ç¦»å¼€ï¼Œå¦†å°è¢«æ’¬ï¼Œé¦–é¥°ç›’ç©ºç½®ã€‚" },
        { title: "è­¦æ–¹æ¡ˆå·", content: "ç£å¯Ÿå½“æ™šå°†éœçº³é€®æ•ã€‚è™½æœªæœå‡ºå®çŸ³ï¼Œä½†å› å…¶æœ‰å‰ç§‘ï¼Œè­¦æ–¹ç¡®ä¿¡æ˜¯å…¶ä½œæ¡ˆå¹¶å·²è½¬ç§»èµƒç‰©ã€‚" },
        { title: "åº­å®¡ç°åœº", content: "éœçº³æƒ…ç»ªæåº¦æ¿€åŠ¨ï¼Œæ¿€çƒˆæŠ—è¾©æ— è¾œï¼Œå½“åº­æ™•å¥ã€‚æ¡ˆä»¶å·²ç§»äº¤å·¡å›æ³•åº­å®¡ç†ã€‚" }
    ],
    editor_comment: "ã€Šæ³°æ™¤å£«æŠ¥ã€‹è­¦åŠ¡ç‰ˆ",
};

const SUGGESTIONS = [
    { label: "æŠ¥è­¦", text: "å»è‹æ ¼å…°åœºï¼ˆè­¦å¯Ÿå±€ï¼‰ï¼Œè¯·æ±‚è­¦æ–¹ååŠ©ã€‚" },
    { label: "ç™»æŠ¥", text: "åœ¨æ™šæŠ¥ä¸ŠåˆŠç™»â€œå¤±ç‰©æ‹›é¢†â€å¯äº‹ã€‚" },
    { label: "é—®è¯¢", text: "å»æ¡åˆ°å¸½å­çš„å¤å‰è¡—æ‹è§’ï¼ŒæŒ¨å®¶æŒ¨æˆ·æ•²é—¨è¯¢é—®ã€‚" },
    { label: "å‡ºåŠ¨å°åˆ†é˜Ÿ", text: "åŠ¨ç”¨æˆ‘çš„â€œè´å…‹è¡—å°åˆ†é˜Ÿâ€ï¼Œå…¨åŸæ‚¬èµæ‰“å¬ã€‚" }
];

// --- ç»„ä»¶ï¼šæ‰“å­—æœº ---
const Typewriter = ({ text, onComplete }) => {
  const [display, setDisplay] = useState("");
  const [index, setIndex] = useState(0);
  useEffect(() => { setDisplay(""); setIndex(0); }, [text]);
  useEffect(() => {
    if (index < text.length) {
      const t = setTimeout(() => { setDisplay(v => v + text.charAt(index)); setIndex(i => i + 1); }, 25);
      return () => clearTimeout(t);
    } else if (onComplete) onComplete();
  }, [index, text, onComplete]);
  return <span>{display}</span>;
};

const App = () => {
  const [gameState, setGameState] = useState('INTRO'); // INTRO, TIMES_REVEAL, STRATEGY_INPUT, PROCESSING_DIALOGUE, NEWSPAPER_REVEAL, SUCCESS_END
  const [script, setScript] = useState(ACT2_INTRO_SCRIPT_PART1);
  const [scriptIdx, setScriptIdx] = useState(0);
  const [isTyping, setIsTyping] = useState(true);
  
  const [strategyInput, setStrategyInput] = useState("");
  const [isBgmPlaying, setIsBgmPlaying] = useState(true);
  const [currentEasterEgg, setCurrentEasterEgg] = useState(null);
  const [failedAttempts, setFailedAttempts] = useState(0); // è®°å½•å¤±è´¥æ¬¡æ•°
  
  // æŠ¥çº¸ä¸APIç›¸å…³çŠ¶æ€
  const [isGenerating, setIsGenerating] = useState(false);
  const [newspaperData, setNewspaperData] = useState(null);
  const [errorMsg, setErrorMsg] = useState('');
  
  const bgmRef = useRef(null);
  const audioRef = useRef(null);

  const curLine = script[scriptIdx] || {};

  // è§’è‰²è¯­éŸ³æ§åˆ¶ Effect
  useEffect(() => {
      // åœæ­¢ä¹‹å‰çš„éŸ³é¢‘
      if (audioRef.current) {
          audioRef.current.pause();
          audioRef.current = null;
      }
      // å¦‚æœå½“å‰è¡Œæœ‰éŸ³é¢‘ï¼Œåˆ™æ’­æ”¾ï¼ˆä¸­æ–‡æ–‡ä»¶åéœ€è¦ç¼–ç ï¼‰
      if (curLine && curLine.audio) {
          const audioUrl = encodeURI(curLine.audio);
          const audio = new Audio(audioUrl);
          audioRef.current = audio;
          audio.load();
          audio.play().catch(e => console.log("Audio play failed:", e));
      }
  }, [scriptIdx, script]);

  // BGM æ§åˆ¶
  useEffect(() => {
      if (bgmRef.current) {
          if (isBgmPlaying) {
              bgmRef.current.volume = 0.3;
              bgmRef.current.play().catch(e => console.log("BGM play failed", e));
          } else {
              bgmRef.current.pause();
          }
      }
  }, [isBgmPlaying]);

  const handleNextLine = () => {
    // å¦‚æœæ­£åœ¨ç”Ÿæˆä¸­ä¸”å½“å‰æ˜¯æœ€åä¸€å¥ï¼Œé˜»æ­¢ç»§ç»­
    if (isGenerating && scriptIdx >= script.length - 1) return;

    if (isTyping) { setIsTyping(false); return; }
    if (scriptIdx < script.length - 1) {
      setScriptIdx(i => i + 1);
      setIsTyping(true);
    } else {
      const current = script[scriptIdx];
      if (current.nextState) setGameState(current.nextState);
    }
  };

  const handleSuggestionClick = (text) => {
      setStrategyInput(text);
  };

  const handleSubmitStrategy = async () => {
      if (!strategyInput.trim()) return;
      
      // 1. åˆ‡æ¢åˆ°å¯¹è¯æ¨¡å¼ï¼Œæ˜¾ç¤ºç©å®¶è¾“å…¥
      const playerDialogue = [
          { speaker: "æˆ‘", text: strategyInput, char: "CHAR_PLAYER" },
          { speaker: "ç³»ç»Ÿ", text: "ï¼ˆç¦å°”æ‘©æ–¯æ­£åœ¨æ¨æ¼”è¯¥è®¡åˆ’çš„å¯èƒ½æ€§...ï¼‰", isThinking: true }
      ];
      setScript(playerDialogue);
      setScriptIdx(0);
      setGameState('PROCESSING_DIALOGUE');
      setIsTyping(true);
      setIsGenerating(true);

      try {
          // 2. è°ƒç”¨ Dify API (workflow run)
          const response = await fetch(`${DIFY_BASE_URL}/workflows/run`, {
              method: 'POST',
              headers: {
                  'Authorization': `Bearer ${DIFY_API_KEY}`,
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  inputs: { user_input: strategyInput },
                  response_mode: "blocking",
                  user: "player-act2"
              })
          });

          if (!response.ok) throw new Error("API Request Failed");

          const data = await response.json();
          // Workflow æ¨¡å¼ä¸‹ï¼Œç»“æœé€šå¸¸åœ¨ data.data.outputs ä¸­
          const outputs = data.data.outputs;
          
          console.log("Dify Workflow Result:", outputs);

          // è§£æ Dify è¿”å›çš„åµŒå¥— JSON å­—ç¬¦ä¸²
          let result = null;
          
          // 1. å°è¯•éå† outputs å¯»æ‰¾åŒ…å« JSON çš„å­—ç¬¦ä¸²å­—æ®µ (å› ä¸º Dify LLM èŠ‚ç‚¹è¾“å‡ºé€šå¸¸æ˜¯å­—ç¬¦ä¸²)
          if (outputs) {
              for (const key in outputs) {
                  if (typeof outputs[key] === 'string') {
                      try {
                          // å°è¯•æå– JSON éƒ¨åˆ† (åº”å¯¹ Dify è¿”å›åŒ…å« Markdown æˆ–å…¶ä»–å‰ç¼€çš„æƒ…å†µ)
                          const jsonMatch = outputs[key].match(/\{[\s\S]*\}/);
                          const jsonStr = jsonMatch ? jsonMatch[0] : outputs[key];
                          
                          // å°è¯•è§£æå­—ç¬¦ä¸²
                          const parsed = JSON.parse(jsonStr);
                          
                          // æ£€æŸ¥è§£æåçš„å¯¹è±¡ç»“æ„
                          if (parsed.structured_output) {
                              result = parsed.structured_output;
                              break;
                          } else if (parsed.status) {
                              result = parsed;
                              break;
                          }
                      } catch (e) {
                          // console.log("Parsing failed for key:", key);
                      }
                  }
              }
          }

          // 2. å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œæ£€æŸ¥ outputs æœ¬èº«æ˜¯å¦å°±æ˜¯ç»“æ„åŒ–å¯¹è±¡
          if (!result && outputs) {
              if (outputs.structured_output) {
                  result = outputs.structured_output;
              } else if (outputs.status) {
                  result = outputs;
              }
          }

          if (!result) {
              console.error("æ— æ³•è§£æ API è¿”å›æ•°æ®:", outputs);
              throw new Error("API è¿”å›æ•°æ®æ ¼å¼æ— æ³•è¯†åˆ«");
          }

          console.log("Parsed Result:", result);

          // 3. æ ¹æ®è¿”å›çŠ¶æ€å¤„ç†å‰§æƒ…
          if (result && result.status === 'STRATEGY') {
              console.log("Setting newspaper data:", result.payload);
              setNewspaperData(result.payload);
              // éšæœºé€‰æ‹©ä¸€ä¸ªå½©è›‹
              const eggs = GAME_CONFIG.sidebars.easterEggs;
              setCurrentEasterEgg(eggs[Math.floor(Math.random() * eggs.length)]);
              setFailedAttempts(prev => prev + 1); // å¢åŠ å¤±è´¥æ¬¡æ•°
          } else if (result && result.status === 'CHAT') {
              setFailedAttempts(prev => prev + 1); // CHAT çŠ¶æ€ä¹Ÿç®—ä½œå°è¯•
          }

          setScript(prev => {
              // ç§»é™¤"æ­£åœ¨æ€è€ƒ"çš„å ä½ç¬¦
              const newScript = prev.filter(line => !line.isThinking);
              
              if (result.status === 'CHAT') {
                  // CHAT ä¹Ÿå¯èƒ½è¿”å› dialogue æ•°ç»„æˆ–å•æ¡ message
                  const chatContent = result.payload.dialogue 
                      ? result.payload.dialogue.map(d => ({
                          speaker: d.name === "Sherlock" ? "ç¦å°”æ‘©æ–¯" : (d.name === "Watson" ? "åç”Ÿ" : d.name),
                          text: d.content,
                          char: d.name === "Sherlock" ? "CHAR_HOLMES" : (d.name === "Watson" ? "CHAR_WATSON" : null),
                          nextState: "STRATEGY_INPUT"
                        }))
                      : [{ 
                          speaker: "ç¦å°”æ‘©æ–¯", 
                          text: result.payload.message, 
                          char: "CHAR_HOLMES", 
                          nextState: "STRATEGY_INPUT" 
                        }];
                  return [...newScript, ...chatContent];
          } else if (result.status === 'STRATEGY') {
              // è§£æå¯¹è¯åˆ—è¡¨
              const dialogueScript = (result.payload.dialogue || []).map(d => ({
                  speaker: d.name === "Sherlock" ? "ç¦å°”æ‘©æ–¯" : (d.name === "Watson" ? "åç”Ÿ" : d.name),
                  text: d.content,
                  char: d.name === "Sherlock" ? "CHAR_HOLMES" : (d.name === "Watson" ? "CHAR_WATSON" : null)
              }));

              return [...newScript, 
                  ...dialogueScript,
                  { 
                      speaker: "æ—ç™½", 
                      text: result.payload.transfer || "ç¬¬äºŒå¤©â€¦â€¦", 
                      isTimePassage: true,
                      nextState: "NEWSPAPER_REVEAL" 
                  }
              ];
          } else if (result.status === 'CORRECT') {
                  return [...newScript, 
                      { speaker: "æˆ‘", text: "æˆ‘ä»¬ä¸èƒ½å¤§å¼ æ——é¼“ã€‚ä»–æ˜¯ä¸ªç©·äººï¼Œä¸¢äº†æ˜‚è´µçš„å¸½å­å’Œæ™šé¤ä¸€å®šå¾ˆå¿ƒç–¼ã€‚æˆ‘ä»¬è¦ç™»æŠ¥æ‹›é¢†ï¼Œé‚£æ˜¯ä»–å”¯ä¸€çš„å¸Œæœ›ï¼", char: "CHAR_PLAYER" },
                      { speaker: "ç¦å°”æ‘©æ–¯", text: "ï¼ˆæ‰“äº†ä¸ªå“æŒ‡ï¼Œçœ¼ç¥èµè®¸ï¼‰å®Œç¾çš„ç­–ç•¥ï¼", char: "CHAR_HOLMES", audio:"./voice/chapter2/sherlock/å®Œç¾çš„ç­–ç•¥ï¼.m4a" },
                      { speaker: "ç¦å°”æ‘©æ–¯", text: "ä¸æå®çŸ³ï¼Œåªæé¹…å’Œå¸½å­ã€‚å¦‚æœä»–æ˜¯æ— è¾œçš„ï¼Œä»–ä¼šä¸ºäº†æ™šé¤è€Œæ¥ï¼›å¦‚æœä»–å¿ƒè™šï¼Œè¿™åˆ™å¹¿å‘Šå°±æ˜¯æœ€å¥½çš„è¯•é‡‘çŸ³ã€‚", char: "CHAR_HOLMES", audio:"./voice/chapter2/sherlock/ä¸æå®çŸ³ï¼Œåª.m4a" },
                      { speaker: "åç”Ÿ", text: "å®Œç¾çš„å¿ƒç†æˆ˜ï¼", char: "CHAR_WATSON" },
                      { speaker: "ç¦å°”æ‘©æ–¯", text: "å½¼å¾—æ£®ï¼Œå»æŠŠè¿™ä¸ªå¯äº‹ç™»åœ¨ã€Šç¯çƒæŠ¥ã€‹ã€ã€Šæ˜ŸæŠ¥ã€‹ã€ã€Šæœ´å°”è«å°”å…¬æŠ¥ã€‹ã€ã€Šåœ£è©¹å§†æ–¯çºªäº‹æŠ¥ã€‹ã€ã€Šæ——å¸œæ™šæŠ¥ã€‹ã€ã€Šå›å£°æŠ¥ã€‹â€¦â€¦æ‰€æœ‰ä½ æƒ³å¾—èµ·æ¥çš„æ™šæŠ¥ä¸Šã€‚", char: "CHAR_HOLMES", audio:"./voice/chapter2/sherlock/å½¼å¾—æ£®ï¼Œå»æŠŠ.m4a" },
                      { speaker: "å½¼å¾—æ£®", text: "å¥½çš„å…ˆç”Ÿã€‚ä½†è¿™å®çŸ³ï¼Ÿ", char:"CHAR_PETERSON" },
                      { speaker: "ç¦å°”æ‘©æ–¯", text: "æˆ‘å…ˆæ›¿ä¼¯çˆµå¤«äººä¿ç®¡ã€‚å¦å¤–ï¼Œå½¼å¾—æ£®ï¼Œå›æ¥è·¯ä¸Šä¹°åªæ–°é¹…ï¼Œæˆ‘ä»¬è¦èµ”ç»™è´å…‹å…ˆç”Ÿã€‚", char: "CHAR_HOLMES", audio:"./voice/chapter2/sherlock/æˆ‘å…ˆæ›¿ä¼¯çˆµå¤«.m4a" },
                      { speaker: "æ—ç™½", text: "ï¼ˆå½¼å¾—æ£®é¢†å‘½è€Œå»ã€‚ç¦å°”æ‘©æ–¯è½¬å‘çª—å¤–çº·é£çš„å¤§é›ªã€‚ï¼‰" },
                      { speaker: "ç¦å°”æ‘©æ–¯", text: "ç°åœ¨æ˜¯ä¸Šåˆ10ç‚¹ã€‚ç­‰åˆ°ä¸‹åˆå…­ç‚¹åŠï¼Œæˆ‘ä»¬è¦ä¹ˆä¼šè¿æ¥ä¸€ä½æ„Ÿæ¿€æ¶•é›¶çš„å®¢äººï¼Œè¦ä¹ˆä¼šè¿æ¥ä¸€ä½ç‹¡çŒ¾çš„é‡ç½ªçŠ¯ã€‚", char: "CHAR_HOLMES", audio:"./voice/chapter2/sherlock/ç°åœ¨æ˜¯ä¸Šåˆ1.m4a" },
                      { speaker: "ç¦å°”æ‘©æ–¯", text: "ç°åœ¨ï¼Œæˆ‘ä»¬ç­‰å¾…ã€‚", char: "CHAR_HOLMES", audio:"./voice/chapter2/sherlock/ç°åœ¨ï¼Œæˆ‘ä»¬ç­‰.m4a", nextState: "SUCCESS_END" }
                  ];
              }
              return newScript;
          });

      } catch (error) {
          console.error(error);
          setErrorMsg("æ€ç»´æ®¿å ‚è¿æ¥ä¸­æ–­ï¼Œè¯·é‡è¯•...");
          setScript(prev => prev.filter(line => !line.isThinking).concat({
              speaker: "ç³»ç»Ÿ", text: "ï¼ˆè¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡è¯•ï¼‰", nextState: "STRATEGY_INPUT"
          }));
      } finally {
          setIsGenerating(false);
          // å¦‚æœå½“å‰åœç•™åœ¨æ€è€ƒä¸­ï¼Œè‡ªåŠ¨æ¨è¿›ä¸€è¡Œ
          if (scriptIdx === 0 && !isTyping) {
             // handleNextLine(); // è®©ç”¨æˆ·è‡ªå·±ç‚¹æˆ–è€…è‡ªåŠ¨è·³ï¼Œè¿™é‡Œé€‰æ‹©è®©ç”¨æˆ·ç‚¹ï¼Œå› ä¸ºæ€è€ƒæ–‡æ¡ˆå·²ç»å˜äº†
          }
      }
  };

  return (
    <div className="flex flex-col h-screen bg-[#FDFBF7] text-[#433D35] font-serif max-w-md mx-auto relative overflow-hidden shadow-2xl border-x-4 border-[#E8E2D6]">
        <audio ref={bgmRef} src={ASSETS.BGM} loop />
        
        {/* BGM å¼€å…³ */}
        <button 
            onClick={() => setIsBgmPlaying(!isBgmPlaying)} 
            className="absolute top-4 left-4 z-[60] bg-white/90 p-2 rounded-full shadow-lg border border-slate-200 text-slate-600 active:scale-95 transition-all"
        >
            {isBgmPlaying ? <span className="animate-spin-slow inline-block">ğŸµ</span> : <span className="opacity-50">ğŸ”‡</span>}
        </button>

        {/* --- SCENE: DIALOGUE (INTRO & PROCESSING) --- */}
        {(gameState === 'INTRO' || gameState === 'PROCESSING_DIALOGUE' || gameState === 'SUCCESS_END') && (
            <div className="flex flex-col h-full bg-[#1a1a1c] relative animate-in fade-in" onClick={handleNextLine}>
                <div className="absolute inset-0 z-0">
                    <img src={ASSETS.BG_CLIMAX} className="w-full h-full object-cover opacity-90 blur-[1px]" alt="bg" />
                    <div className="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent" />
                    
                    {/* Dark overlay for time passage */}
                    {curLine.isTimePassage && <div className="absolute inset-0 bg-black/80 transition-opacity duration-1000 z-10" />} 
                </div>
                <div className="absolute inset-0 z-10 flex items-end justify-center pointer-events-none">
                    {/* Hide character if time passage */}
                    {curLine.char && !curLine.isTimePassage && <img key={curLine.char} src={ASSETS[curLine.char]} className="h-[130%] object-contain drop-shadow-2xl animate-in slide-in-from-bottom duration-700 translate-y-[15%]" alt="tachie" />}
                </div>

                <div className="absolute top-[52%] left-4 right-4 z-20">
                    {/* Center text for time passage */}
                    {curLine.isTimePassage ? (
                         <div className="flex items-center justify-center min-h-[140px]">
                             <p className="text-white text-xl font-black italic tracking-widest animate-pulse">{curLine.text}</p>
                         </div>
                    ) : (
                        <div className="bg-white/95 backdrop-blur-md border-2 border-[#D1C7B7] rounded-3xl shadow-2xl p-6 min-h-[140px] relative">
                            {curLine.speaker && <div className="absolute -top-4 left-6 bg-indigo-600 text-white px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest shadow-md border-2 border-white">{String(curLine.speaker)}</div>}
                            <div className="text-[15px] text-[#2a1f16] leading-relaxed italic">
                                <Typewriter text={String(curLine.text || "")} onComplete={() => setIsTyping(false)} />
                            </div>
                            {/* å¦‚æœæ˜¯æ­£åœ¨æ€è€ƒä¸­ï¼Œæ˜¾ç¤º Loading å›¾æ ‡ */}
                            {curLine.isThinking && isGenerating ? (
                                <div className="absolute bottom-4 right-6 text-indigo-400 animate-spin"><Loader2 size={18} /></div>
                            ) : (
                                !isTyping && <div className="absolute bottom-4 right-6 text-indigo-400 animate-bounce"><ArrowRight size={18} /></div>
                            )}
                            
                            {/* æˆåŠŸç»“æŸæ—¶çš„æŒ‰é’® */}
                            {gameState === 'SUCCESS_END' && !isTyping && scriptIdx === script.length - 1 && (
                                <button 
                                    onClick={(e) => { e.stopPropagation(); alert("ç¬¬äºŒå¹•å®Œã€‚æ•¬è¯·æœŸå¾…ç¬¬ä¸‰å¹•ï¼"); }} 
                                    className="absolute -bottom-12 left-1/2 -translate-x-1/2 px-8 py-3 bg-indigo-600 text-white font-black text-xs uppercase tracking-[0.2em] rounded-full shadow-lg animate-in slide-in-from-bottom"
                                >
                                    è¿›å…¥ä¸‹ä¸€å¹•
                                </button>
                            )}
                        </div>
                    )}
                </div>
            </div>
        )}

        {/* --- SCENE: STRATEGY INPUT --- */}
        {gameState === 'STRATEGY_INPUT' && (
            <div className="flex flex-col h-full bg-[#1a1a1c] relative animate-in zoom-in">
                {/* èƒŒæ™¯æ¨¡ç³Šå¤„ç† */}
                <div className="absolute inset-0 z-0">
                    <img src={ASSETS.BG_CLIMAX} className="w-full h-full object-cover opacity-40 blur-md" alt="bg" />
                    <div className="absolute inset-0 bg-black/60" />
                </div>

                <div className="relative z-10 flex flex-col h-full p-6">
                    <div className="flex-1 flex flex-col justify-center max-w-sm mx-auto w-full">
                        <div className="text-center mb-8 animate-in slide-in-from-top duration-700">
                            <h2 className="text-2xl font-black text-white mb-2 flex items-center justify-center gap-2">
                                <Lightbulb className="text-yellow-400" fill="currentColor" /> åˆ¶å®šæœæŸ¥è®¡åˆ’
                            </h2>
                            <p className="text-white/60 text-sm font-serif italic">â€œè¿™å°±çœ‹ä½ æ€ä¹ˆè¿ç”¨è¿™äº›çº¿ç´¢äº†ï¼Œå°é˜Ÿé•¿ã€‚â€</p>
                        </div>

                        {/* å»ºè®®è¯ */}
                        <div className="flex flex-wrap justify-center gap-2 mb-6">
                            {SUGGESTIONS.map((sug, idx) => {
                                const isHint = failedAttempts >= 3 && sug.label === "ç™»æŠ¥";
                                return (
                                    <button 
                                        key={idx}
                                        onClick={() => handleSuggestionClick(sug.text)}
                                        className={`px-4 py-2 rounded-full text-xs font-bold transition-all active:scale-95 animate-in zoom-in ${
                                            isHint 
                                            ? 'bg-yellow-400 text-black border-2 border-yellow-500 shadow-[0_0_15px_rgba(250,204,21,0.6)] animate-pulse' 
                                            : 'bg-white/10 hover:bg-indigo-600 hover:text-white text-indigo-200 border border-indigo-500/30'
                                        }`}
                                        style={{ animationDelay: `${idx * 100}ms` }}
                                    >
                                        {sug.label}
                                        {isHint && <span className="ml-1 text-[10px]">âœ¨</span>}
                                    </button>
                                );
                            })}
                        </div>

                        {/* è¾“å…¥æ¡†åŒºåŸŸ */}
                        <div className="bg-white rounded-2xl p-2 shadow-2xl animate-in slide-in-from-bottom duration-700 delay-300">
                            <textarea
                                value={strategyInput}
                                onChange={(e) => setStrategyInput(e.target.value)}
                                placeholder="è¾“å…¥ä½ çš„è¡ŒåŠ¨è®¡åˆ’..."
                                className="w-full h-32 p-4 bg-slate-50 rounded-xl text-slate-800 text-sm font-serif leading-relaxed focus:outline-none focus:ring-2 focus:ring-indigo-500/50 resize-none"
                            />
                            <div className="flex justify-end p-2">
                                <button 
                                    onClick={handleSubmitStrategy}
                                    disabled={!strategyInput.trim() || isGenerating}
                                    className={`flex items-center gap-2 px-6 py-2 rounded-lg font-black text-xs uppercase tracking-wider transition-all ${
                                        strategyInput.trim() && !isGenerating
                                        ? 'bg-indigo-900 text-white hover:bg-indigo-800 shadow-lg' 
                                        : 'bg-slate-200 text-slate-400 cursor-not-allowed'
                                    }`}
                                >
                                    {isGenerating ? <Loader2 className="animate-spin" size={14} /> : <><Send size={14} /> æäº¤è®¡åˆ’</>}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        )}

        {/* æ³°æ™¤å£«æŠ¥å¼¹å‡ºå±‚ (å‰§æƒ…å±•ç¤º) */}
        {gameState === 'TIMES_REVEAL' && (
            <div className="absolute inset-0 bg-black/90 flex items-center justify-center z-[100] p-4 animate-newspaper-in">
              <div className="bg-[#f2eecb] text-[#1a1612] w-full max-w-sm h-auto max-h-[90vh] shadow-[0_0_80px_rgba(0,0,0,0.8)] border-8 border-double border-[#2c241b] relative flex flex-col overflow-hidden rounded-sm">
                
                {/* çº¸å¼ çº¹ç† */}
                <div className="absolute inset-0 opacity-20 pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/paper-fibers.png')] mix-blend-multiply"></div>
                <div className="absolute inset-0 opacity-10 pointer-events-none bg-gradient-to-br from-yellow-900/10 to-transparent"></div>
                
                {/* æŠ¥å¤´åŒºåŸŸ */}
                <header className="flex-shrink-0 border-b-4 border-[#1a1612] p-3 pb-1 text-center relative z-10">
                  <div className="flex justify-between items-end border-b-2 border-[#1a1612] pb-1 mb-1 px-1">
                     <span className="text-[9px] font-bold uppercase tracking-widest text-[#4a3b2a]">$0.10</span>
                     <span className="text-[9px] font-bold uppercase tracking-widest text-[#4a3b2a]">Dec 23, 1889</span>
                     <span className="text-[9px] font-bold uppercase tracking-widest text-[#4a3b2a]">No. 9,876</span>
                  </div>
                  <h1 className="font-serif text-4xl font-black text-[#1a1612] tracking-tighter scale-y-90 mb-0.5">
                    The Times
                  </h1>
                  <p className="text-[9px] italic font-serif text-[#4a3b2a] border-t border-[#1a1612] pt-0.5 mt-0.5 truncate">
                    "Repara que quien habla elogiosamente de sÃ­ mismo, cuanto mÃ¡s se alaba..."
                  </p>
                </header>

                {/* å†…å®¹åŒºåŸŸ (æ— æ»šåŠ¨ï¼Œç´§å‡‘å¸ƒå±€) */}
                <div className="flex-1 overflow-hidden relative z-10 p-3 pt-2 flex flex-col">
                    {/* ä¸»å¤´æ¡ & å›¾ç‰‡ */}
                    <div className="mb-2 shrink-0">
                        <h2 className="font-serif text-lg font-bold leading-none mb-1 text-center uppercase border-b border-black/10 pb-1">
                           {TIMES_ARTICLE.newspaper_headline}
                        </h2>
                        
                        {/* å›¾ç‰‡åŒºåŸŸ - ç¼©å°é«˜åº¦ */}
                        <div className="relative w-full h-32 bg-gray-200 mb-2 overflow-hidden border-2 border-[#1a1612] shadow-inner group">
                            <img 
                                src={ASSETS.BG_CLIMAX} 
                                className="w-full h-full object-cover grayscale contrast-125 brightness-90 group-hover:scale-105 transition-transform duration-1000"
                                alt="Blue Carbuncle"
                            />
                            <img 
                                src="./pic/event_blueCarbuncle.png" 
                                className="absolute inset-0 w-full h-full object-contain p-2 grayscale contrast-125 brightness-110 drop-shadow-xl"
                                alt="The Gem"
                            />
                            <div className="absolute bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm py-0.5 px-2 border-t border-[#1a1612]">
                                <p className="text-[8px] font-bold uppercase text-center tracking-wider">Fig 1. The Stolen Blue Carbuncle</p>
                            </div>
                        </div>
                    </div>

                    {/* æ–‡æœ¬å—å¸ƒå±€ (Grid) - çºµå‘åˆ†å‰²ï¼Œç´§å‡‘å¸ƒå±€ */ }
                    <div className="grid grid-cols-2 gap-x-4 gap-y-2 flex-1 min-h-0 relative">
                        {/* çºµå‘åˆ†å‰²çº¿ */}
                        <div className="absolute top-0 bottom-0 left-1/2 w-px bg-[#1a1612]/20 -translate-x-1/2"></div>
                        
                        {TIMES_ARTICLE.blocks.map((block, idx) => (
                            <div key={idx} className={`flex flex-col justify-start ${idx === 0 ? 'col-span-2 pb-2 border-b border-[#1a1612]/20 mb-1' : 'col-span-1'}`}>
                                <h3 className="font-sans text-[9px] font-black uppercase border-b border-black/10 pb-0.5 mb-0.5 tracking-wider text-[#2c241b] leading-tight inline-block">
                                    {block.title}
                                </h3>
                                <p className="font-serif text-[10px] leading-snug text-justify text-[#1a1612]">
                                    {block.content}
                                </p>
                            </div>
                        ))}
                    </div>

                    {/* åº•éƒ¨ Footer */}
                    <div className="mt-1 pt-1 border-t-2 border-double border-[#1a1612] text-center shrink-0">
                         <span className="bg-[#1a1612] text-[#f2eecb] px-2 py-0.5 text-[8px] font-bold uppercase tracking-widest">
                            Police Report - Page 3
                         </span>
                    </div>
                </div>

                {/* åº•éƒ¨æŒ‰é’® */}
                <button 
                  onClick={() => {
                    setScript(ACT2_INTRO_SCRIPT_PART2);
                    setScriptIdx(0);
                    setGameState('INTRO');
                    setIsTyping(true);
                  }}
                  className="flex-shrink-0 w-full py-3 bg-[#1a1612] text-[#f2eecb] font-black uppercase tracking-[0.2em] hover:bg-[#333] transition-colors text-xs border-t-4 border-[#2c241b] relative z-20"
                >
                  <span className="flex items-center justify-center gap-2">
                     æ”¾ä¸‹æŠ¥çº¸ <ArrowRight size={14} />
                  </span>
                </button>
              </div>
            </div>
        )}

        {/* æŠ¥çº¸å¼¹å‡ºå±‚ (å¤±è´¥åˆ†æ”¯) */}
        {gameState === 'NEWSPAPER_REVEAL' && (
            <div className="absolute inset-0 bg-black/90 flex items-center justify-center z-[100] p-4 animate-newspaper-in">
              <div className="bg-[#f0e6d2] text-[#1a1612] w-full max-w-sm p-6 shadow-[0_0_80px_rgba(0,0,0,0.8)] border-double border-8 border-[#1a1612] relative flex flex-col gap-4 overflow-hidden rotate-1">
                <div className="absolute inset-0 opacity-10 pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/old-map.png')]"></div>
                
                {/* æŠ¥å¤´ */}
                <div className="border-b-4 border-[#1a1612] pb-4 text-center relative z-10">
                  <div className="text-[10px] font-bold flex justify-between mb-1 uppercase tracking-tighter">
                    <span>EST. 1855</span>
                    <span>London</span>
                  </div>
                  <h2 className="text-3xl font-black uppercase font-serif tracking-tighter italic border-y-2 border-[#1a1612] py-2 mb-2">
                    The Chronicle
                  </h2>
                  <div className="flex justify-between text-[10px] font-black italic">
                    <span>No. 23,491</span>
                    <span>DEC 27, 1890</span>
                  </div>
                </div>
                
                <div className="relative z-10">
                    <h3 className="text-xl font-black leading-tight text-center mb-4 underline decoration-double">
                      {newspaperData?.newspaper_headline || newspaperData?.headline || "ã€æ— æœçš„æœå¯»ã€‘"}
                    </h3>
                    <p className="text-sm leading-[1.6] font-serif text-justify">
                      <span className="text-4xl float-left mr-2 font-black mt-[-8px]">
                        {(newspaperData?.newspaper_body || newspaperData?.body || "ä¾¦æ¢").charAt(0)}
                      </span>
                      {(newspaperData?.newspaper_body || newspaperData?.body || "ä¾¦æ¢çš„å¤±è¯¯è®©æ•´æ¡è¡—é“é™·å…¥æ··ä¹±ã€‚").slice(1)}
                    </p>
                    <div className="mt-6 pt-4 border-t border-dotted border-[#1a1612] italic text-xs font-bold text-right">
                      â€”â€” {newspaperData?.editor_comment || newspaperData?.footer || "â€œå†æ¥å†å‰å§ã€‚â€"}
                    </div>
                </div>

                <div className="bg-black/5 p-3 mt-2 border-t-2 border-[#1a1612]">
                    <h4 className="text-[10px] font-black uppercase mb-1">æœ¬å‘¨çƒ­é—¨ï¼š{currentEasterEgg?.title}</h4>
                    <p className="text-[10px] italic">{currentEasterEgg?.content}</p>
                </div>

                <button 
                  onClick={() => {
                    setGameState('STRATEGY_INPUT');
                    setStrategyInput('');
                  }}
                  className="mt-4 w-full py-3 bg-[#1a1612] text-[#f0e6d2] font-black uppercase tracking-widest hover:bg-[#333] transition-colors shadow-lg active:scale-95 text-xs"
                >
                  æ’•ç¢æŠ¥çº¸ï¼Œé‡æ–°æ„æƒ³
                </button>
              </div>
            </div>
        )}

        {errorMsg && (
            <div className="fixed bottom-6 right-6 bg-red-900 text-white px-4 py-2 rounded shadow-2xl flex items-center gap-3 animate-fade-in z-[100] border border-red-500">
              <AlertCircle size={20} /> <span className="font-bold text-xs">{errorMsg}</span>
            </div>
        )}

        <style>{`
            @keyframes newspaper-in {
              0% { opacity: 0; transform: scale(0.3) rotate(-45deg) translateY(500px); }
              70% { transform: scale(1.05) rotate(3deg) translateY(-20px); }
              100% { opacity: 1; transform: scale(1) rotate(1deg) translateY(0); }
            }
            .animate-newspaper-in { animation: newspaper-in 0.8s cubic-bezier(0.19, 1, 0.22, 1) forwards; }
        `}</style>
    </div>
  );
};

const root = createRoot(document.getElementById('root'));
root.render(<App />);
    </script>
</body>
</html>
